<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@latest/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/wavesurfer.js"></script>
  <style>
    #waveform {
      height: 200px;
    }
  </style>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand" href="/">&nbsp;&nbsp;&nbsp;&nbsp;<i class="bi bi-emoji-laughing"></i> Nala</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/">History</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/">Commands</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/">API docs</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/logout">Logout</a>
      </li>
    </ul>
  </div>
</nav>


<center>
  <title>ü¶Å Nala</title>
</head>
<body>
  <div class="container mt-5">
    <div class="row">
      <div class="col">
        <div id='description'><h4><em>Start by <strong>clicking listen</strong></em></h4></div>
        <hr></hr>
        <div class="d-flex flex-column align-items-center mt-4">
          <button id="recordBtn" class="btn btn-danger-outline"><i class="bi bi-mic"></i> Listen</button>
          <button id="stopBtn" class="btn btn-black-outline" disabled><i class="bi bi-stop-circle"></i> Stop</button> 
          <button id="playBtn" class="btn btn-black-outline" disabled><i class="bi bi-play-circle"></i> Play</button>
        </div>
      </div>
    </div>
    <div class="row mt-5">
      <div class="col">
        <div id="waveform"></div>
      </div>
    </div>
  </div>

  <audio id="audioPlayer"></audio>

<script>
var audioContext;
var mediaRecorder;
var chunks = [];
var audioBlob;
var waveform;

// Initialize the audio context
function initAudioContext() {
  if (typeof AudioContext !== 'undefined') {
    audioContext = new AudioContext();
  } else if (typeof webkitAudioContext !== 'undefined') {
    audioContext = new webkitAudioContext();
  } else {
    console.error('Web Audio API is not supported in this browser.');
  }
}

// Start recording
function startRecording() {
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(function(stream) {
      mediaRecorder = new MediaRecorder(stream);
      chunks = [];

      mediaRecorder.addEventListener('dataavailable', function(e) {
        chunks.push(e.data);
      });

      mediaRecorder.start();

      // stop after inactivity
      startRecognition();

      recordBtn.disabled = true;
      playBtn.disabled = true;
      stopBtn.disabled = false;
    })
    .catch(function(err) {
      console.error('Error accessing microphone: ', err);
    });
}

// Stop recording
function stopRecording() {
  mediaRecorder.stop();

  mediaRecorder.addEventListener('stop', function() {
    audioBlob = new Blob(chunks, { type: mediaRecorder.mimeType });

    recordBtn.disabled = false;
    stopBtn.disabled = true;
    playBtn.disabled = false;

    createWaveform();
    // continue streaming back-to-back
    recordBtn.click();
  });
}

// Play recorded audio
function playAudio() {
  // var audioElement = document.getElementById('audioPlayer');
  // audioElement.src = URL.createObjectURL(audioBlob);
  // audioElement.play();
  document.getElementById("waveform").innerHTML = "";
  var waveformElement = document.getElementById('waveform');
  waveform = WaveSurfer.create({
    container: waveformElement,
    waveColor: 'violet',
    progressColor: 'purple',
    barHeight: 3,
    height: 200,
    responsive: true
  });
  waveform.loadBlob(audioBlob);
  waveform.on('ready', function () {
      waveform.play();
  });
}

// Create waveform using Wavesurfer.js
function createWaveform() {
  playAudio();
}

// Wakeword detection
function detectWakeword() {
  document.getElementById('description').innerHTML = "<em><h4>now say <strong>hey nala</strong> to query</h4></em>"
  document.getElementById('recordBtn').style.display = "none";
  var recognition = new webkitSpeechRecognition();
  recognition.continuous = true;
  recognition.lang = 'en-US';

  recognition.onresult = function(event) {
    for (var i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        var transcript = event.results[i][0].transcript.toLowerCase();
        if (transcript.includes('nala')) {
          document.getElementById('description').innerHTML = "<em><h4>now make a query like <strong>make a song</strong></h4> and then press the stop button.</em>"
          startRecording();
          recognition.stop();
          break;
        }
      }
    }
  };

  recognition.start();
}

// Initialize audio context and event listeners
document.addEventListener('DOMContentLoaded', function() {
  initAudioContext();

  var recordBtn = document.getElementById('recordBtn');
  var stopBtn = document.getElementById('stopBtn');
  var playBtn = document.getElementById('playBtn');

  recordBtn.addEventListener('click', detectWakeword);
  stopBtn.addEventListener('click', stopRecording);
  playBtn.addEventListener('click', playAudio);
});

function startSilenceTimeout() {
  const silenceDuration = 3000; // Adjust this value as needed (in milliseconds)

  silenceTimeout = setTimeout(() => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      // Disable/enable buttons
      stopRecording();
      console.log('Recording stopped due to inactivity.');
    }
  }, silenceDuration);
}


// Start speech recognition
function startRecognition() {
  recognition = new webkitSpeechRecognition();
  recognition.continuous = true;

  // Speech recognition event handlers
  recognition.onresult = (event) => {
    const result = event.results[event.results.length - 1];
    const transcript = result[0].transcript.trim();

    if (transcript !== '') {
      clearTimeout(silenceTimeout); // Reset silence detection timeout
      startSilenceTimeout(); // Restart silence detection
    }
  };

  recognition.onend = () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      stopRecognition();
      mediaRecorder.stop();

      // Disable/enable buttons
      startBtn.disabled = false;
      stopBtn.disabled = true;

      console.log('Recording stopped due to speech recognition end.');
    }
  };

  recognition.start();
}

// Stop speech recognition
function stopRecognition() {
  if (recognition) {
    recognition.stop();
    recognition = null;
  }
}


</script>
</center>
</body>
</html>
